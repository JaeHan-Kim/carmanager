<!DOCTYPE HTML>
<!-- 현재 스크립트나 CSS 임포트는 각 기능이 있는 위치에 쓰여있기 때문에 
     실제로 사용할 때 정리해서 사용할 것을 권장합니다. -->
<html>
<head>
<title>new 내 차를 부탁해</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" />
<link type='text/css' rel="stylesheet"
  href="../css/community/communityForm.css">
<link type='text/css' rel="stylesheet"
  href="../css/community/cstyle.css">
<link type='text/css' rel="stylesheet"
  href="../css/community/default.css">
<link type='text/css' rel='stylesheet'
  href="../lib/bootstrap/css/bootstrap.css" />
<link type='text/css' rel="stylesheet"
  href="../lib/sweetalert/sweetalert.css">
<link type="text/css" rel="stylesheet" media="all"
  href="../css/main/animate.css">
<link type="text/css" rel="stylesheet" href="../css/main/custom.css">
<link type='text/css' rel='stylesheet' href="../css/main/style.css" />
<link type='text/css' rel='stylesheet'
  href='http://fonts.googleapis.com/css?family=PT+Sans:400,700'>
<link type='text/css' rel='stylesheet'
  href='http://fonts.googleapis.com/css?family=Roboto+Condensed:400,300,300italic,400italic,700,700italic'>
<link type='text/css' rel='stylesheet'
  href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow&v1' />
<link type='text/css' rel='stylesheet'
  href='http://fonts.googleapis.com/css?family=Oswald' />
<link type='text/css' rel='stylesheet'
  href='http://fonts.googleapis.com/css?family=Ovo' />
<link
  href="http://netdna.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.css"
  rel="stylesheet">
<link type='text/css' rel="stylesheet"
  href="../lib/summernote/summernote.css">


<script src="../lib/jquery/jquery.min.js"></script>
<script src="../lib/sweetalert/sweetalert.min.js"></script>
<script src="../lib/bootstrap/js/bootstrap.min.js"></script>
<script src="../lib/summernote/summernote.js"></script>
<script src="../js/main/classie.js"></script>
<script src="../js/main/custom.js"></script>
<script src="../js/main/metisMenu.min.js"></script>
<script src="../js/main/modernizr.custom.js"></script>
<script src="../js/main/moment_local.js"></script>
<script src="../js/main/wow.min.js"></script>

<script>
  new WOW().init();
  var imageCount = new Array();
  $(document).ready(function() {
    sessionStorage.removeItem('searchCategory');
    var userNickname = sessionStorage.getItem('loginUserNickname') + "님";
    var userCarNo = sessionStorage.getItem("selectCarNo");
    var userPhoto = sessionStorage.getItem('loginUserPhoto');
    $("#userNickname").html(userNickname);
    $("#thumbnail").attr("src", "../img/member/m-" + userPhoto + ".png");
    $('#summernote').summernote({
      lang : 'ko-KR',
      height : 300,
      minHeight: 300,
      maxHeight: 300,
      focus: true,    
      callbacks : {
        onImageUpload : function(files, editor, welEditable) {
          sendFile(files[0], editor, welEditable);
        }
      }

    });
  });
</script>

<script type="application/x-javascript">
  
    addEventListener("load", function() { 
    setTimeout(hideURLbar, 0); }, false); 
    function hideURLbar(){ 
    window.scrollTo(0,1); } 
  
</script>

</head>

<body class="cbp-spmenu-push">
  <div class="main-content">
    <div class=" sidebar" role="navigation">
      <div class="navbar-collapse">
        <nav class="cbp-spmenu cbp-spmenu-vertical cbp-spmenu-left"
          id="cbp-spmenu-s1">
          <ul class="nav" id="side-menu">
            <li><a href="../main/main.html" class=""><i
                class="  nav_icon"></i><img class="img_menu"
                src="../img/main/dash.png">Dashboard</a></li>
            <li><a href="../mypage/mypage.html" class=""><i
                class="  nav_icon"></i><img class="img_menu"
                src="../img/main/mypage.png">My page</a></li>
            <li><a href="../garage/garage.html" class=""><i
                class="  nav_icon"></i><img class="img_menu"
                src="../img/main/garage.png">차량 등록</a></li>
            <li><a href="../refuel/refuelManager.html" class=""><i
                class="  nav_icon"></i><img class="img_menu"
                src="../img/main/refuel.png">차량 관리</a></li>
            <li><a href="../center/center.html" class=""><i
                class="  nav_icon"></i><img class="img_menu"
                src="../img/main/center.png">정 비 소</a></li>
            <li><a href="../goods/goods.html" class=""><i
                class="  nav_icon"></i><img class="img_menu"
                src="../img/main/goods.png">맞춤 서비스</a></li>
            <li><a href="../community/community.html"
              id="menu_active" class=""><i class="  nav_icon"></i><img
                class="img_menu" src="../img/main/community.png">커뮤니티</a></li>
          </ul>
        </nav>
      </div>
    </div>
    <div class="sticky-header header-section ">
      <div class="header-left">
        <!--toggle button start-->
        <button id="showLeftPush">
          <img class="img_menubtn" src="../img/main/menu.png">
        </button>
        <!--toggle button end-->
        <!--logo -->
        <div class="logo">
          <a href="../main/main.html">
            <h1>내 차를 부탁해</h1> <span>간편, 쉽고, 재밌는 시작!</span>
          </a>
        </div>
      </div>

      <div class="header-right">
                <!-- 로그인 유저 정보 -->
        <div class="profile_details">
          <ul>
            <li class="dropdown profile_details_drop">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                <div class="profile_img">
                  <span class="prfil-img">
                  <img id="thumbnail" class="img-rounded" src="" alt=""> </span>
                  <div class="user-name">
                    <p id="userNickname"></p>
                    <span>반갑습니다 : )</span>
                  </div>
                  <!-- 빈칸 유지를 위한 아이콘 자리 -->
                  <i class="fa fa-angle-down lnr"></i>
                  <i class="fa fa-angle-up lnr"></i>
                  <div class="clearfix"></div>
                </div>
            </a>
            <!-- 유저별 차량 리스트 -->
              <ul id="myCarList" class="dropdown-menu drp-mnu">
              </ul>
            <!-- 유저별 차량 리스트 end -->
            </li>
          </ul>
        </div>
        <!-- 로그인 유저 정보 end -->
        <div class="clearfix"></div>
      </div>
      <div class="clearfix"></div>
    </div>
    <!-- //header-ends -->
    <script>
    $.getJSON('../main/list.do?no=' + sessionStorage.getItem("loginUser") + '&carNo='+sessionStorage.getItem("selectCarNo"), function(resultObj) {
      for (var garage of resultObj.data) {
        if (sessionStorage.getItem("selectCarNo") == garage.myCarNo) {
          $('#selectedMyCar').html(garage.nickName);
        }
        $("<li><a class='link' href='#' carNo = '"+ garage.myCarNo +"' carName = '"+ garage.nickName +"'><i class='nav_icon'></i><img class='img_mycar' src='../img/main/mycar.png'>"+ garage.nickName +"</a></li>").appendTo('#myCarList');
     	} 
      $("<li><a class='link' carNo = 'Logout' href='#'><i class='nav_icon'></i><img class='img_logout' src='../img/main/logout.png'>Logout</a></li>").appendTo('#myCarList');
      $("a.link").click(clickLink);
   	});
    function clickLink(event) {
      event.preventDefault();
      if ($(event.target).attr("carNo") == 'Logout') {
          sessionStorage.removeItem('loginUserNickname');
      /*  sessionStorage.removeItem('loginUsercarNo'); */
          sessionStorage.removeItem('loginUserPhoto');
          sessionStorage.removeItem('selectCarNo');
          location.href = "../auth/login.html";
      } else {
        $('#selectedMyCar').html($(event.target).attr("carName"));
        sessionStorage.setItem('selectCarNo', $(this).attr("carNo"));
      }
        
    }
    </script>

    <div id="page-wrapper">
      <div class="main-page">
        <div>
          <h3 class="title1">커뮤니티에 들어오셨습니다&nbsp;:</h3>
          <h4>근거 없는 비방, 홍보, 관련되지 않은 게시물은 관리자에 의해 삭제 될 수 있습니다.</h4>
          <p>&nbsp;</p>
        </div>
        <div class="col-md-8 compose-right widget-shadow">
          <form class="form-horizontal">

            <div class="panel-default">
              <div class="panel-heading">
                <div class="col-md-3">
                  <select id="category" class="form-control">
                    <option value="">카테고리</option>
                    <option value="소모품">자유</option>
                    <option value="소모품">소모품</option>
                    <option value="정비소">정비소</option>
                  </select>
                </div>
                <div class="col-md-8">
                  <input id="txt_title" type="text"
                    class="form-control1" placeholder="제목을 입력하세요.">
                </div>
                <div class="clearfix"></div>
              </div>
              <div class="panel-body" id="summernote"></div>
              <div class="panel-heading">
                <div class="btn_set">
                  <button id='addBtn' type='button'
                    class="newForm btn btn-default">글쓰기</button>
                  <button id='updateBtn' type='button'
                    class="updateForm btn btn-default">수정</button>
                  &nbsp;
                  <button id='listBtn' type='button'
                    class="btn btn-default">목록</button>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="clearfix"></div>

      </div>
    </div>

    <div class="footer">
      <p>
        &copy; 2016 Java76th 태웅 재한 영호 다인. All Rights Reserved | Project
        by <a href="" target="_blank">내 차를 부탁해</a>
      </p>
    </div>
  </div>
  <script>
      /* 원래 있는거 */
      var menuLeft = document.getElementById('cbp-spmenu-s1'), showLeftPush = document
          .getElementById('showLeftPush'), body = document.body;

      showLeftPush.onclick = function() {
        classie.toggle(this, 'active');
        classie.toggle(body, 'cbp-spmenu-push-toright');
        classie.toggle(menuLeft, 'cbp-spmenu-open');
        disableOther('showLeftPush');
      };
      
  function disableOther(button) {
    if (button !== 'showLeftPush') {
      classie.toggle(showLeftPush, 'disabled');
    }
  }
  /* 원래 있는거 */
  var no = location.href.split('?')[1].split('=')[1];
  var savedPhoto;
  /* alert(no); */
  if (no > -1) {
    $('.updateForm').css('display', '');
  	$('.newForm').css('display', 'none');
    $.getJSON('../community/ajax/alterText.do?no=' + no, function(resultObj) {
      var ajaxResult = resultObj.ajaxResult;
      if (ajaxResult.status == "success") {
        var board = ajaxResult.data;
        $("#txt_title").val(board.title);
        $("#category").val(board.category);
        $('#summernote').summernote('code', board.content);
        savedPhoto = board.photo
      }
    });
  } else {
    $('.updateForm').css('display', 'none');
  	$('.newForm').css('display', '');
  }
  
  $('#addBtn').click(function(event) {
    var content = $('#summernote').summernote('code');
    if ($('#category').val() == "") {
      swal({   
        title: "Error!",   
        text: "카테고리를 선택해주세요!",   
        type: "error",   
        confirmButtonText: "확인" });
      return false;
    }
    if ($('#txt_title').val().length < 1) {
      swal({   
        title: "Error!",   
        text: "제목을 입력해주세요!",   
        type: "error",   
        confirmButtonText: "확인" });
      return false;
    }
    if (content.length ==  11 || content.length  < 0) {
      swal({   
        title: "Error!",   
        text: "내용을 입력해주세요!",   
        type: "error",   
        confirmButtonText: "확인" });
      return false;
    }
   
    /* alert(content.length); */
    var imageFile = "";
    if(typeof imageCount[0] != "undefined") {
   	var str = imageCount[0].split('/');
    	str[3] = "c-" + str[3].substring(0,str[3].lastIndexOf('.')) + ".png";
  	  for (var i = 0; i < str.length; i++) {
   		imageFile = imageFile + str[i] + "/";
    	} 
    	imageFile = imageFile.substring(0,imageFile.lastIndexOf('/'));
    }
    if (imageFile == "") {
      imageFile = "../img/community/defaultImage.png"
    }
    $.post('ajax/addText.do', {
      userNo: sessionStorage.getItem("loginUser"),
      title: $("#txt_title").val(),
      content: content,
      category: $("#category").val(),
      imageFile: imageFile
    }, function(resultObj) {
     
        location.href = "community.html";
    }, 'json');
  });
  function sendFile(file,editor,welEditable) {
    /*  alert(file.size);
     alert(file.name); */
       data = new FormData();
       data.append("file", file);//You can append as many data as you want. Check mozilla docs for this
       data.append("imageCnt", imageCount.length);
       $.ajax({
           data: data,
           type: "POST",
           url: 'ajax/imageUpload.do',
           cache: false,
           contentType: false,
           processData: false,
           success: function(url) {
            console.log(url);
            imageCount.push(url);
            $('#summernote').summernote('insertImage', url);
          }
        });
      }
  $('#updateBtn').click(function(event) {
    var content = $('#summernote').summernote('code');
    var imageFile = "";
		var alterImageFile;
		var parsedcon = content.split("<");
		/* 	alert(parsedcon.length); */
		for (var i = 0; i < parsedcon.length; i++) {
	 	  if(parsedcon[i].substring(0,3) == 'img') {
	 	   alterImageFile = parsedcon[i];
		  	break;
		  }
		}
		if(typeof alterImageFile != "undefined") {
			parsedcon = alterImageFile.split(" ");
			alterImageFile = parsedcon[1].substring(parsedcon[1].indexOf('"')+1,parsedcon[1].lastIndexOf('"'));
			var alterStr = alterImageFile.split('/');
			var originStr = savedPhoto.split('/');
			alterStr[3] = "c-" + alterStr[3].substring(0,alterStr[3].lastIndexOf('.')) + ".png";
			if (alterStr[3] == originStr[3]) {
			  imageFile = savedPhoto;
			} else {
			  for (var i = 0; i < alterStr.length; i++) {
	     		imageFile = imageFile + alterStr[i] + "/";
	      } 
	      imageFile = imageFile.substring(0,imageFile.lastIndexOf('/'));
			}
		} else {
		  imageFile = "../img/community/defaultImage.png";
		}
		
		alert(imageFile);
    $.post('ajax/updateText.do', {
      boardNo: no,
      content: content,
      category: $("#category").val(),
      imageFile: imageFile,
      title: $("#txt_title").val()
    }, function(resultObj) {
       location.href = "community.html";
    }, 'json');
  });
      $('#listBtn').click(function(event) {
        location.href = "community.html";
      });
    </script>
  <script src="../js/main/jquery.nicescroll.js"></script>
  <script src="../js/main/scripts.js"></script>
</body>
</html>